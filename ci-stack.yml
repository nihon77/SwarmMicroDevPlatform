version: "3.8"

services:
  woodpecker-server:
      image: woodpeckerci/woodpecker-server:v3
      environment:
        - WOODPECKER_OPEN=true
        - WOODPECKER_GITEA=false
        - WOODPECKER_GITHUB=true
        - WOODPECKER_PLUGINS_PRIVILEGED=woodpeckerci/plugin-docker-buildx:6.0.1
      volumes:
        - woodpecker-server-data:/var/lib/woodpecker/
      networks:
        - traefik-net
      deploy:
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.ci.rule=Host(`ci.oci.${DOMAIN_BASE}`)"
          - "traefik.http.routers.ci.entrypoints=websecure"
          - "traefik.http.routers.ci.tls.certresolver=${CERT_RESOLVER}"
          - "traefik.http.services.ci.loadbalancer.server.port=8000"

    woodpecker-agent:
      image: woodpeckerci/woodpecker-agent:v3
      environment:
        - WOODPECKER_SERVER=woodpecker-server:9000
      volumes:
        - woodpecker-agent-config:/etc/woodpecker
        - /var/run/docker.sock:/var/run/docker.sock
      networks:
        - traefik-net
      deploy:
        #mode: global
        placement:
          constraints:
            - node.role == manager

networks:
  traefik-net:
    external: true

volumes:
  woodpecker-server-data:
  woodpecker-agent-config: